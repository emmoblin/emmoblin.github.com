---
title: shell代码片段收集
layout: post
filename: shell snippet collect
on: 2012-12-05 15:00:37
toc: on
comments: true
categories: [shell]
CATEGORY: shell_snippet_collect
---

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">shell代码片段收集</a>
<ul>
<li><a href="#sec-1-1">获取磁盘大小</a></li>
<li><a href="#sec-1-2">变为大写</a></li>
<li><a href="#sec-1-3">判断返回值</a></li>
<li><a href="#sec-1-4">提问</a></li>
<li><a href="#sec-1-5">for循环</a></li>
<li><a href="#sec-1-6">while and until</a></li>
<li><a href="#sec-1-7">case</a></li>
<li><a href="#sec-1-8">读取文件</a></li>
<li><a href="#sec-1-9">awk按域搜索的例子</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1"><a href="http://emmoblin.github.com{{ page.url }}">shell代码片段收集</a></h2>
<div class="outline-text-2" id="text-1">


<p><br/>
</p>
</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">获取磁盘大小</h3>
<div class="outline-text-3" id="text-1-1">


<p><br/>
<pre class="src src-sh"><span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Return the size of the drive in MB</span>
get_drive_size () {
  <span style="color: #ff1493;">ldrive</span>=$<span style="color: #ff1493;">1</span>

  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Make sure you can print disk info using parted</span>
  parted --script /dev/$<span style="color: #ff1493;">ldrive</span> print &gt;/dev/null 2&gt;&amp;1

  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">If unable to read disk, it's likely it needs a disklabel</span>
  <span style="color: #0000ff;">if</span> [  <span style="color: #00bfff;">"$?"</span> != <span style="color: #00bfff;">"0"</span> ]; <span style="color: #0000ff;">then</span>
    <span style="color: #a52a2a;">echo</span> <span style="color: #00bfff;">"Creating a new disklabel on $ldrive"</span> &gt;&gt; $<span style="color: #ff1493;">INSTALL_LOG</span>
    <span style="color: #a52a2a;">echo</span> <span style="color: #00bfff;">"parted /dev/$ldrive mklabel msdos"</span> &gt;&gt; $<span style="color: #ff1493;">INSTALL_LOG</span>
    <span style="color: #ff1493;">output</span>=$(<span style="color: #ff00ff;">parted</span> -s /dev/$<span style="color: #ff1493;">ldrive</span> mklabel msdos)

    <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Get the drive size from parted</span>
    <span style="color: #ff1493;">lsize</span>=$(<span style="color: #ff00ff;">parted</span> -s /dev/$<span style="color: #ff1493;">ldrive</span> p | grep <span style="color: #00bfff;">"^Disk"</span> | awk <span style="color: #00bfff;">'{ print $3 }'</span>)

    <span style="color: #0000ff;">if</span> [ $(<span style="color: #ff00ff;">echo</span> $<span style="color: #ff1493;">lsize</span> | grep error) ]; <span style="color: #0000ff;">then</span>
      <span style="color: #a52a2a;">echo</span> <span style="color: #00bfff;">"Unable to read disk label.  Exiting."</span>
      <span style="color: #0000ff;">exit</span> 1
    <span style="color: #0000ff;">fi</span>
  <span style="color: #0000ff;">fi</span>

  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Get the drive size from parted</span>
  <span style="color: #ff1493;">lsize</span>=$(<span style="color: #ff00ff;">parted</span> -s /dev/$<span style="color: #ff1493;">ldrive</span> p | grep <span style="color: #00bfff;">"^Disk"</span> | awk <span style="color: #00bfff;">'{ print $3 }'</span>)
  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Get the reported units (mB, GB, kB)</span>
  <span style="color: #ff1493;">lmodifier</span>=$(<span style="color: #ff00ff;">echo</span> $<span style="color: #ff1493;">lsize</span> | sed <span style="color: #00bfff;">'s/[0-9\.]//g'</span>)
  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">remove the modifier</span>
  <span style="color: #ff1493;">lsize</span>=$(<span style="color: #ff00ff;">echo</span> $<span style="color: #ff1493;">lsize</span> | sed <span style="color: #00bfff;">'s/[a-z,A-Z]//g'</span>)
  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Remove any fractions</span>
  <span style="color: #ff1493;">lsize</span>=$(<span style="color: #ff00ff;">echo</span> $<span style="color: #ff1493;">lsize</span> | cut -f1 -d<span style="color: #00bfff;">'.'</span>)
  <span style="color: #8c8c8c; font-style: italic;"># </span><span style="color: #8c8c8c; font-style: italic;">Translate our size into mB if not there already</span>
  <span style="color: #0000ff;">if</span> [ $<span style="color: #ff1493;">lmodifier</span> = <span style="color: #00bfff;">"GB"</span> ]; <span style="color: #0000ff;">then</span> 
    <span style="color: #ff1493;">lsize</span>=$(($<span style="color: #ff1493;">lsize</span> * 1000))
  <span style="color: #0000ff;">elif</span> [ $<span style="color: #ff1493;">lmodifier</span> = <span style="color: #00bfff;">"kB"</span> ]; <span style="color: #0000ff;">then</span> 
    <span style="color: #ff1493;">lsize</span>=$(($<span style="color: #ff1493;">lsize</span> / 1000))
  <span style="color: #0000ff;">fi</span>

  <span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">lsize</span>
}

</pre>


disk_size=`fdisk -l $CF | grep MB | cut -d":" -f2 | cut -d "," -f1| sed s/MB//g `<br/>
</p>
<p><br/>
</p></div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">变为大写</h3>
<div class="outline-text-3" id="text-1-2">


<p><br/>
<pre class="src src-sh">upper_str()
{
        <span style="color: #ff1493;">upper</span>=<span style="color: #ff00ff;">`echo $1 | tr "[a-z]" "[A-Z]"`</span>
        <span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">upper</span>
}
</pre>


</p></div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">判断返回值</h3>
<div class="outline-text-3" id="text-1-3">


<p><br/>
<pre class="src src-sh"><span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">TOS_VERSION</span> | grep <span style="color: #00bfff;">"^3.3.016"</span> 
<span style="color: #0000ff;">if</span> [  $? != 0  ]
<span style="color: #0000ff;">then</span> 
        <span style="color: #ff1493;">VERSION_016</span>=<span style="color: #00bfff;">"false"</span>
<span style="color: #0000ff;">else</span>
        <span style="color: #ff1493;">VERSION_016</span>=<span style="color: #00bfff;">"true"</span>
<span style="color: #0000ff;">fi</span>
</pre>


</p></div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">提问</h3>
<div class="outline-text-3" id="text-1-4">


<p><br/>
<pre class="src src-sh">auto_echo <span style="color: #00bfff;">"Are you sure to begin[y/n]:"</span>
<span style="color: #0000ff;">while </span><span style="color: #a52a2a;">read</span> answer
<span style="color: #0000ff;">do</span>
<span style="color: #ff1493;">answer</span>=<span style="color: #ff00ff;">`upper_str $answer`</span>
<span style="color: #0000ff;">if</span> [ <span style="color: #00bfff;">"$answer"</span> = <span style="color: #00bfff;">"Y"</span> ] 
<span style="color: #0000ff;">then</span>
<span style="color: #0000ff;">break</span>
<span style="color: #0000ff;">elif</span> [ <span style="color: #00bfff;">"$answer"</span> = <span style="color: #00bfff;">"N"</span> ] 
<span style="color: #0000ff;">then</span>
write_free
<span style="color: #0000ff;">exit</span>
<span style="color: #0000ff;">fi</span>
auto_echo <span style="color: #00bfff;">"Are you sure to begin[y/n]:"</span>
<span style="color: #0000ff;">done</span>
</pre>

</p></div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5">for循环</h3>
<div class="outline-text-3" id="text-1-5">


<p><br/>
<pre class="src src-sh"><span style="color: #0000ff;">for</span> x<span style="color: #0000ff;"> in</span> /var/log/*
<span style="color: #0000ff;">do</span>
    <span style="color: #a52a2a;">echo</span> <span style="color: #ff00ff;">`basename $x`</span> is a file living<span style="color: #0000ff;"> in</span> /var/log
<span style="color: #0000ff;">done</span>
</pre>

</p>
<p> <br/>
</p></div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6">while and until</h3>
<div class="outline-text-3" id="text-1-6">


<p><br/>
<pre class="src src-sh"><span style="color: #ff1493;">myvar</span>=0
<span style="color: #0000ff;">while</span> [ $<span style="color: #ff1493;">myvar</span> -ne 10 ]
<span style="color: #0000ff;">do</span>
    <span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">myvar</span>
    <span style="color: #ff1493;">myvar</span>=$(( $<span style="color: #ff1493;">myvar</span> + 1 ))
<span style="color: #0000ff;">done</span>


<span style="color: #ff1493;">myvar</span>=0
<span style="color: #0000ff;">until</span> [ $<span style="color: #ff1493;">myvar</span> -eq 10 ]
<span style="color: #0000ff;">do</span>
    <span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">myvar</span>
    <span style="color: #ff1493;">myvar</span>=$(( $<span style="color: #ff1493;">myvar</span> + 1 ))
<span style="color: #0000ff;">done</span>
</pre>


</p></div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7">case</h3>
<div class="outline-text-3" id="text-1-7">

<p>*$x为文件名，只获取文件的后缀，至于是为什么现在不明白? *<br/>
</p>
<p><br/>
<pre class="src src-sh"><span style="color: #0000ff;">case</span> <span style="color: #00bfff;">"${x##*.}"</span><span style="color: #0000ff;"> in</span>
     gz)
           gzunpack ${<span style="color: #ff1493;">SROOT</span>}/${<span style="color: #ff1493;">x</span>}
           ;;
     bz2)
           bz2unpack ${<span style="color: #ff1493;">SROOT</span>}/${<span style="color: #ff1493;">x</span>}
           ;;
     *)
           <span style="color: #a52a2a;">echo</span> <span style="color: #00bfff;">"Archive format not recognized."</span>
           <span style="color: #0000ff;">exit</span>
           ;;
<span style="color: #0000ff;">esac</span>
</pre>


</p></div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8">读取文件</h3>
<div class="outline-text-3" id="text-1-8">


<p><br/>
<pre class="src src-sh"><span style="color: #8c8c8c; font-style: italic;">#</span><span style="color: #8c8c8c; font-style: italic;">! /bin/</span><span style="color: #0000ff;">bash</span><span style="color: #8c8c8c; font-style: italic;">  </span>
<span style="color: #0000ff;">while </span><span style="color: #a52a2a;">read</span> LINE
<span style="color: #0000ff;">do</span>
        <span style="color: #a52a2a;">echo</span> $<span style="color: #ff1493;">LINE</span> 
<span style="color: #0000ff;">done</span> &lt; /etc/passwd
</pre>


</p></div>

</div>

<div id="outline-container-1-9" class="outline-3">
<h3 id="sec-1-9">awk按域搜索的例子</h3>
<div class="outline-text-3" id="text-1-9">


<p><br/>
<pre class="src src-sh"><span style="color: #0000ff;">while </span><span style="color: #a52a2a;">read</span> line; 
        <span style="color: #0000ff;">do</span> cp aaaa $<span style="color: #ff1493;">line</span>;
<span style="color: #0000ff;">done</span> &lt;&lt; (awk <span style="color: #00bfff;">'{for(i=1; i &lt;= NF; ++i){if($i ~/^-l/){gsub("^-l","lib",$i); printf("%s.so\n", $i)}}}'</span> libso.txt  | sort -u)
</pre>

</p></div>
</div>
</div>
